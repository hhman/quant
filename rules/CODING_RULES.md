# 编码规则（强制）

本规则用于约束 Agent 的编码与重构行为。
目标是产出 **干净、可删除、可重写、不承载历史的代码**。

---

## 一、核心原则（不可违反）

### 1. 代码只表达「现在是什么」

代码中严禁表达：
- 曾经是什么
- 未来可能是什么
- 为了兼容旧逻辑而存在的内容

历史信息只能存在于：
- git commit
- 对话记录
- issue / PR

**当前代码是唯一真相。**

---

### 2. 禁止向前兼容

以下行为一律禁止：

- 保留旧参数、旧接口、旧分支
- 通过 flag / mode 维持多套逻辑
- try / except 回退到旧实现
- 任何"过渡期""暂时保留"的代码

如发现旧逻辑不再需要：
- 直接删除
- 不做兼容
- 不做兜底

宁可破坏，也不妥协。

---

## 二、注释规则（高压区）

### 3. 严禁的注释类型

代码中 **绝对禁止** 以下注释：

- 过程性注释
  - "先做 A，再做 B"
  - "这里读取数据然后计算"

- 历史注释
  - "之前的实现是……"
  - "旧版本逻辑"
  - "原来这里……"

- 时间线注释
  - "暂时保留"
  - "后面可能会用到"
  - "以后再优化"

任何体现「时间变化」的注释都是违规。

---

### 4. 允许的注释（仅限以下）

仅允许两种注释形式：

#### 4.1 模块级 docstring
用于说明：
- 本模块的职责
- 本模块不负责的内容

#### 4.2 WHY 注释
- 解释业务 / 金融 / 数学原因
- 不解释执行流程
- 不解释代码本身

如果一个注释在解释"代码怎么跑"：
→ 说明代码结构不合格，必须重构。

---

### 5. 函数注释的强制规范（必须遵守）

**每一个对外函数必须有函数级 docstring，且必须包含：**

- 输入参数的类型说明
- 返回值的类型说明

要求：
- 只描述 *接口语义*
- 不描述实现过程
- 不包含历史或对比说明

不允许：
- 空 docstring
- 只写一句废话
- 用注释代替类型信息

---

## 三、结构与重构规范

### 6. 函数与文件职责

- 一个函数只能有一个清晰职责
- 一个文件只能对应一个领域概念
- orchestration / pipeline 文件：
  - 只负责编排
  - 不承载业务逻辑

---

### 7. 重构时的强制清理行为

当 Agent 修改或重构代码时，必须同步完成：

- 删除无用参数
- 删除废弃分支
- 删除不再调用的函数
- 删除相关的历史注释

不允许：
- "保留但不用"
- "先留着"

---

## 四、错误与失败策略

### 8. 失败即失败

禁止：
- 静默失败
- catch 后不抛出
- fallback 到旧逻辑

错误必须：
- 立即暴露
- 明确失败位置

---

## 五、表达与风格约束

### 9. 禁止非工程表达

在代码、注释、docstring 中：

- **严禁出现 emoji**
- 严禁调侃性、情绪化、教学式语言

代码只服务于工程目的。

---

## 六、Agent 输出约束

### 10. 涉及代码修改时的输出顺序

除非用户明确要求直接给实现，否则 Agent 必须：

1. 说明对现有代码职责的理解
2. 指出违反本规则的地方
3. 给出重构或修改方案（仅限设计层）
4. 等待确认后再实现

---

## 七、最终裁决

如用户指令与本规则冲突：
- 以用户指令为最高优先级

否则：
- 本规则具有强制约束力
